name: ðŸ› Debug Workers (Interactive SSH Shell)

on:
  workflow_dispatch:
    inputs:
      num_workers:
        description: 'Number of workers to spawn'
        required: false
        default: '2'

env:
  MANAGER_HOST: 165.232.134.47
  NATS_HOST: 165.232.134.47
  NATS_PORT: 4222
  REDIS_HOST: 165.232.134.47
  REDIS_PORT: 6379
  POSTGRES_HOST: 165.232.134.47
  POSTGRES_PORT: 5432
  POSTGRES_DB: mcp_manager
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DOCKER_IMAGE: test123434sdd/mcp-remote-worker:latest

jobs:
  debug-interactive:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max (GitHub Actions limit)
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: test123434sdd
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: ðŸŒ Test Connectivity
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŒ Testing Connection to 165.232.134.47"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Test all ports
          for port in 4222 6379 5432; do
            if nc -zv -w5 ${{ env.MANAGER_HOST }} $port 2>&1; then
              echo "âœ… Port $port: Connected"
            else
              echo "âš ï¸ Port $port: Cannot connect"
            fi
          done
          
          echo ""
          echo "âœ… Connectivity tests complete"

      - name: ðŸ³ Pull Worker Image
        run: |
          echo "ðŸ“¥ Pulling worker Docker image..."
          docker pull ${{ env.DOCKER_IMAGE }}
          echo "âœ… Image pulled"

      - name: ðŸ§¹ Cleanup Old Containers
        run: |
          echo "ðŸ§¹ Cleaning up any old containers..."
          docker ps -a | grep github-worker | awk '{print $1}' | xargs -r docker rm -f || echo "No old containers"
          echo "âœ… Cleanup complete"

      - name: ðŸš€ Spawn Workers
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸš€ Spawning ${{ github.event.inputs.num_workers }} Workers"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          NUM_WORKERS=${{ github.event.inputs.num_workers }}
          RUN_ID="${{ github.run_id }}"
          
          for i in $(seq 1 $NUM_WORKERS); do
            WORKER_NAME="github-worker-${RUN_ID}-$i"
            WORKER_ID="github-debug-worker-${RUN_ID}-$i"
            
            echo "ðŸ”§ Starting Worker $i/$NUM_WORKERS"
            echo "   Name: $WORKER_NAME"
            echo "   ID: $WORKER_ID"
            
            docker run -d \
              --name $WORKER_NAME \
              -e WORKER_ID="$WORKER_ID" \
              -e WORKER_TAGS="github-actions,debug,interactive,run-$RUN_ID" \
              -e MANAGER_HOST="${{ env.MANAGER_HOST }}" \
              -e NATS_HOST="${{ env.NATS_HOST }}" \
              -e REDIS_HOST="${{ env.REDIS_HOST }}" \
              -e REDIS_PASSWORD="" \
              -e POSTGRES_HOST="${{ env.POSTGRES_HOST }}" \
              -e POSTGRES_PASSWORD="${{ env.POSTGRES_PASSWORD }}" \
              -v /tmp/screenshots-$i:/root \
              ${{ env.DOCKER_IMAGE }}
            
            echo "   âœ… Worker $i started"
            echo ""
            
            sleep 2
          done
          
          echo "âœ… All workers spawned!"
          echo ""
          echo "ðŸ“Š Running containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"

      - name: ðŸ“‹ Show Initial Worker Logs
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“‹ Initial Worker Logs"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          for container in $(docker ps --format "{{.Names}}" | grep github-worker); do
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "Worker: $container"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            docker logs --tail 30 $container 2>&1
            echo ""
          done

      - name: ðŸ› Setup tmate SSH Session (INTERACTIVE DEBUG)
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false  # Allow anyone with the link to connect
          timeout-minutes: 300  # 5 hours timeout for SSH session
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Final Status
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š Final Status"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "ðŸ³ Running containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}"
          echo ""
          
          echo "ðŸ“‹ Worker logs (last 50 lines each):"
          for container in $(docker ps --format "{{.Names}}" | grep github-worker); do
            echo ""
            echo "â”€â”€â”€â”€â”€ $container â”€â”€â”€â”€â”€"
            docker logs --tail 50 $container 2>&1
          done

      - name: ðŸ›‘ Cleanup
        if: always()
        run: |
          echo "ðŸ›‘ Stopping and removing workers..."
          docker ps -a | grep github-worker | awk '{print $1}' | xargs -r docker rm -f
          echo "âœ… Cleanup complete"

      - name: ðŸ“ Generate Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ› Interactive Debug Session Complete
          
          ### ðŸŽ¯ What This Workflow Did
          
          1. âœ… Connected to your server (165.232.134.47)
          2. âœ… Pulled worker Docker image
          3. âœ… Spawned workers
          4. âœ… Opened interactive SSH session via tmate
          5. âœ… Allowed real-time debugging
          
          ### ðŸ”§ Debugging Commands You Could Use
          
          ```bash
          # View running containers
          docker ps
          
          # Check worker logs
          docker logs github-worker-{RUN_ID}-1
          
          # Follow worker logs in real-time
          docker logs -f github-worker-{RUN_ID}-1
          
          # Exec into worker container
          docker exec -it github-worker-{RUN_ID}-1 bash
          
          # Check worker's NATS connection
          docker exec github-worker-{RUN_ID}-1 nc -zv 165.232.134.47 4222
          
          # Test manually sending task via NATS
          # (requires nats-cli or custom script)
          
          # Check system resources
          docker stats
          
          # View all logs at once
          docker-compose logs -f  # if using compose
          ```
          
          ### ðŸ’¡ Next Time
          
          To debug again, just trigger this workflow and you'll get an SSH link!
          EOF

