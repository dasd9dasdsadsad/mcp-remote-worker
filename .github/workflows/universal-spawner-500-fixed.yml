name: Universal MCP Worker Spawner - 500 Workers

on:
  workflow_dispatch:
    inputs:
      worker_count_per_job:
        description: 'Number of workers per job'
        required: false
        default: '25'

jobs:
  spawn-workers:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, ubuntu-latest, macos-latest, macos-latest, macos-latest, macos-latest, macos-latest]
        job_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    
    steps:
      - name: Set up Docker (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "âœ… Docker already available on Linux"
          docker --version
      
      - name: Set up Docker (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "ğŸ Setting up Docker on macOS..."
          brew install docker
          colima start --cpu 2 --memory 4
          docker --version
      
      - name: Login to Docker Hub
        run: |
          echo "ğŸ” Logging in to Docker Hub..."
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u ${{ secrets.DOCKER_HUB_USER }} --password-stdin
          echo "âœ… Docker Hub login successful!"
      
      - name: Pull MCP Worker Image
        run: |
          echo "ğŸ“¦ Pulling MCP worker image..."
          docker pull test123434sdd/mcp-remote-worker:latest
          echo "âœ… Image pulled successfully!"
      
      - name: Spawn 25 Workers
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ SPAWNING 25 WORKERS - Job ${{ matrix.job_id }} on ${{ matrix.os }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          WORKER_COUNT=${{ github.event.inputs.worker_count_per_job }}
          if [ -z "$WORKER_COUNT" ]; then
            WORKER_COUNT=25
          fi
          
          for i in $(seq 1 $WORKER_COUNT); do
            WORKER_ID="github-worker-${{ github.run_id }}-job${{ matrix.job_id }}-worker${i}"
            
            echo ""
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ğŸ”· Spawning Worker ${i}/${WORKER_COUNT}"
            echo "ğŸ“‹ Worker ID: ${WORKER_ID}"
            echo "ğŸ–¥ï¸  OS: ${{ matrix.os }}"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            
            docker run -d \
              --name "worker-${i}" \
              --restart unless-stopped \
              -e WORKER_ID="${WORKER_ID}" \
              -e MANAGER_HOST="165.232.134.47" \
              -e NATS_HOST="165.232.134.47" \
              -e NATS_PORT="4222" \
              -e REDIS_HOST="165.232.134.47" \
              -e REDIS_PORT="6379" \
              -e REDIS_PASSWORD="postgres" \
              -e POSTGRES_HOST="165.232.134.47" \
              -e POSTGRES_PORT="5432" \
              -e POSTGRES_DB="mcp_manager" \
              -e POSTGRES_USER="postgres" \
              -e POSTGRES_PASSWORD="postgres" \
              test123434sdd/mcp-remote-worker:latest
            
            echo "âœ… Worker ${i} spawned successfully!"
            
            # Small delay to avoid overwhelming the system
            sleep 2
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ALL 25 WORKERS SPAWNED FOR JOB ${{ matrix.job_id }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Worker Status:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
      
      - name: Monitor Workers
        run: |
          echo "ğŸ‘€ Monitoring workers for 2 hours..."
          echo "Workers will run until workflow timeout or manual cancellation"
          echo ""
          echo "ğŸ”— Connect to MCP Manager at: 165.232.134.47"
          echo "ğŸ“Š Dashboard: http://165.232.134.47:3002"
          echo ""
          
          # Keep the job alive to let workers run
          # Check status every 5 minutes
          for minute in {1..120}; do
            if [ $((minute % 5)) -eq 0 ]; then
              echo ""
              echo "â° Runtime: ${minute} minutes"
              echo "ğŸ“Š Active containers:"
              docker ps --format "table {{.Names}}\t{{.Status}}" | head -10
            fi
            sleep 60
          done
      
      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up workers..."
          docker ps -a --filter "name=worker-" --format "{{.Names}}" | xargs -r docker stop
          docker ps -a --filter "name=worker-" --format "{{.Names}}" | xargs -r docker rm
          echo "âœ… Cleanup complete!"

