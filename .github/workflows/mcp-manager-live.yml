name: MCP Manager + Workers (Connected to 165.232.134.47)

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      runtime_minutes:
        description: 'Runtime in minutes'
        required: false
        default: '30'
      num_workers:
        description: 'Number of workers to spawn'
        required: false
        default: '3'

env:
  MANAGER_HOST: 165.232.134.47
  NATS_HOST: 165.232.134.47
  NATS_PORT: 4222
  REDIS_HOST: 165.232.134.47
  REDIS_PORT: 6379
  POSTGRES_HOST: 165.232.134.47
  POSTGRES_PORT: 5432
  POSTGRES_DB: mcp_manager
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DOCKER_IMAGE: test123434sdd/mcp-remote-worker:latest

jobs:
  run-mcp-manager-and-workers:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: test123434sdd
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: ðŸŒ Test Connectivity to Server
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŒ Testing Connection to 165.232.134.47"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Test NATS
          if nc -zv -w5 ${{ env.NATS_HOST }} ${{ env.NATS_PORT }} 2>&1; then
            echo "âœ… NATS (${{ env.NATS_HOST }}:${{ env.NATS_PORT }}): Connected"
          else
            echo "âŒ NATS (${{ env.NATS_HOST }}:${{ env.NATS_PORT }}): Cannot connect"
            exit 1
          fi
          
          # Test Redis
          if nc -zv -w5 ${{ env.REDIS_HOST }} ${{ env.REDIS_PORT }} 2>&1; then
            echo "âœ… Redis (${{ env.REDIS_HOST }}:${{ env.REDIS_PORT }}): Connected"
          else
            echo "âŒ Redis (${{ env.REDIS_HOST }}:${{ env.REDIS_PORT }}): Cannot connect"
            exit 1
          fi
          
          # Test PostgreSQL
          if nc -zv -w5 ${{ env.POSTGRES_HOST }} ${{ env.POSTGRES_PORT }} 2>&1; then
            echo "âœ… PostgreSQL (${{ env.POSTGRES_HOST }}:${{ env.POSTGRES_PORT }}): Connected"
          else
            echo "âŒ PostgreSQL (${{ env.POSTGRES_HOST }}:${{ env.POSTGRES_PORT }}): Cannot connect"
            exit 1
          fi
          
          echo ""
          echo "âœ… All services accessible from GitHub Actions!"

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd mcp-manager
          npm install

      - name: ðŸŽ¯ Start MCP Manager (Connected to Your Server)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸš€ Starting MCP Manager Connected to 165.232.134.47"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ”— Connecting to YOUR infrastructure:"
          echo "  - NATS:       ${{ env.NATS_HOST }}:${{ env.NATS_PORT }}"
          echo "  - Redis:      ${{ env.REDIS_HOST }}:${{ env.REDIS_PORT }}"
          echo "  - PostgreSQL: ${{ env.POSTGRES_HOST }}:${{ env.POSTGRES_PORT }}"
          echo ""
          echo "ðŸ’¾ All data will be saved to YOUR database!"
          echo ""
          
          cd mcp-manager
          
          # Start MCP Manager with remote connections
          NATS_HOST=${{ env.NATS_HOST }} \
          NATS_PORT=${{ env.NATS_PORT }} \
          REDIS_HOST=${{ env.REDIS_HOST }} \
          REDIS_PORT=${{ env.REDIS_PORT }} \
          POSTGRES_HOST=${{ env.POSTGRES_HOST }} \
          POSTGRES_PORT=${{ env.POSTGRES_PORT }} \
          POSTGRES_DB=${{ env.POSTGRES_DB }} \
          POSTGRES_USER=${{ env.POSTGRES_USER }} \
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }} \
          node index-enhanced.js > /tmp/mcp-manager.log 2>&1 &
          
          MCP_PID=$!
          echo $MCP_PID > /tmp/mcp-manager.pid
          
          echo "â³ Waiting for MCP Manager to connect..."
          sleep 10
          
          # Check if it's running
          if ps -p $MCP_PID > /dev/null; then
            echo "âœ… MCP Manager started and connected!"
            echo "   PID: $MCP_PID"
            echo ""
            echo "ðŸ“‹ Initial logs:"
            head -30 /tmp/mcp-manager.log
          else
            echo "âŒ MCP Manager failed to start!"
            cat /tmp/mcp-manager.log
            exit 1
          fi

      - name: ðŸ³ Pull Worker Docker Image
        run: |
          echo "ðŸ“¥ Pulling worker image..."
          docker pull ${{ env.DOCKER_IMAGE }}
          echo "âœ… Image pulled"

      - name: ðŸš€ Spawn Multiple Workers
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸš€ Spawning ${{ github.event.inputs.num_workers }} Workers"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          NUM_WORKERS=${{ github.event.inputs.num_workers }}
          
          for i in $(seq 1 $NUM_WORKERS); do
            WORKER_NAME="github-worker-$i"
            WORKER_ID="github-actions-worker-$i-$(date +%s)"
            
            echo "ðŸ”§ Starting Worker $i/$NUM_WORKERS"
            echo "   Name: $WORKER_NAME"
            echo "   ID: $WORKER_ID"
            
            docker run -d \
              --name $WORKER_NAME \
              -e WORKER_ID="$WORKER_ID" \
              -e WORKER_TAGS="github-actions,worker-$i,automated" \
              -e MANAGER_HOST="${{ env.MANAGER_HOST }}" \
              -e NATS_HOST="${{ env.NATS_HOST }}" \
              -e REDIS_HOST="${{ env.REDIS_HOST }}" \
              -e REDIS_PASSWORD="" \
              -e POSTGRES_HOST="${{ env.POSTGRES_HOST }}" \
              -e POSTGRES_PASSWORD="${{ env.POSTGRES_PASSWORD }}" \
              -v /tmp/screenshots-$i:/root \
              ${{ env.DOCKER_IMAGE }}
            
            echo "   âœ… Worker $i started (Container ID: $(docker ps -q -f name=$WORKER_NAME))"
            echo ""
            
            sleep 2
          done
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All $NUM_WORKERS workers spawned!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Running containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: ðŸŒ Expose Services Globally with Ngrok
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŒ Making MCP Manager Globally Accessible"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Download ngrok
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok -y
          
          # Start ngrok for NATS (port 4222) - NO AUTH TOKEN NEEDED for basic tunnels
          echo "ðŸš€ Starting ngrok tunnel for NATS..."
          ngrok tcp 4222 --log=stdout > /tmp/ngrok.log 2>&1 &
          NGROK_PID=$!
          echo $NGROK_PID > /tmp/ngrok.pid
          
          # Wait for ngrok to start
          sleep 5
          
          # Get the public URL
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' | sed 's/tcp:\/\///')
          
          if [ -z "$NGROK_URL" ] || [ "$NGROK_URL" == "null" ]; then
            echo "âš ï¸  Ngrok tunnel not available (free tier may be limited)"
            echo "   Manager accessible locally only"
            NGROK_URL="localhost:4222"
          else
            echo "âœ… Ngrok tunnel established!"
            echo ""
            echo "ðŸŒ PUBLIC ACCESS:"
            echo "   NATS: $NGROK_URL"
            echo ""
          fi
          
          # Save to file for other steps
          echo "$NGROK_URL" > /tmp/ngrok_url.txt
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸš€ Spawn Workers to Connect to Manager
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸš€ Spawning Workers"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Get ngrok URL or use localhost
          MANAGER_HOST=$(cat /tmp/ngrok_url.txt | cut -d: -f1)
          MANAGER_PORT=$(cat /tmp/ngrok_url.txt | cut -d: -f2)
          
          if [ "$MANAGER_HOST" == "localhost" ]; then
            echo "ðŸ“ Using local connection (workers in same runner)"
            MANAGER_HOST="localhost"
            MANAGER_PORT="4222"
          else
            echo "ðŸ“ Using public ngrok tunnel"
            echo "   Host: $MANAGER_HOST"
            echo "   Port: $MANAGER_PORT"
          fi
          
          echo ""
          echo "ðŸ³ Pulling worker image..."
          docker pull test123434sdd/mcp-remote-worker:latest
          
          # Spawn 3 workers
          for i in {1..3}; do
            echo ""
            echo "ðŸš€ Starting Worker $i..."
            
            docker run -d \
              --name github-worker-$i \
              -e MANAGER_HOST="$MANAGER_HOST" \
              -e NATS_HOST="$MANAGER_HOST" \
              -e NATS_PORT="$MANAGER_PORT" \
              -e WORKER_ID="github-worker-$i-$(date +%s)" \
              -e WORKER_TAGS="github-actions,auto-spawned,worker-$i" \
              -e REDIS_PASSWORD="" \
              -e POSTGRES_PASSWORD="postgres" \
              -v /tmp/worker-$i:/root \
              test123434sdd/mcp-remote-worker:latest
            
            echo "   âœ… Worker $i spawned (ID: github-worker-$i)"
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All workers spawned!"
          echo ""
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ“Š Display Connection Information
        run: |
          NGROK_URL=$(cat /tmp/ngrok_url.txt)
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ðŸŒ MCP MANAGER GLOBALLY ACCESSIBLE! ðŸŒ           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“¡ PUBLIC CONNECTION:"
          echo ""
          echo "   NATS:  $NGROK_URL"
          echo ""
          echo "ðŸ³ SPAWNED WORKERS:"
          echo "   - github-worker-1 âœ…"
          echo "   - github-worker-2 âœ…"
          echo "   - github-worker-3 âœ…"
          echo ""
          echo "ðŸ“Š To see workers, use MCP Manager tools:"
          echo "   manage_workers({ action: 'list' })"
          echo ""
          echo "ðŸŽ¯ To assign tasks:"
          echo "   assign_task({ worker_id: 'github-worker-1', description: '...' })"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ðŸ”´ Keep System Running
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”´ MCP System is LIVE (Connected to Your Server)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â±ï¸  Runtime: ${{ github.event.inputs.runtime_minutes }} minutes"
          echo "ðŸ”— Using infrastructure at: 165.232.134.47"
          echo "ðŸ’¾ All data saved to YOUR database!"
          echo ""
          
          MCP_PID=$(cat /tmp/mcp-manager.pid)
          RUNTIME_SECONDS=$(($(echo "${{ github.event.inputs.runtime_minutes }}" | bc) * 60))
          END_TIME=$(($(date +%s) + RUNTIME_SECONDS))
          
          while [ $(date +%s) -lt $END_TIME ]; do
            if ps -p $MCP_PID > /dev/null; then
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ“Š Status Update - $(date '+%Y-%m-%d %H:%M:%S')"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              # Show MCP Manager status
              echo "ðŸŽ¯ MCP Manager:"
              ps -p $MCP_PID -o pid,%cpu,%mem,etime | tail -1
              
              # Show workers status
              echo ""
              echo "ðŸ‘· Workers:"
              docker ps --format "   {{.Names}}: {{.Status}}" | grep github-worker || echo "   No workers running"
              
              # Show worker logs sample
              echo ""
              echo "ðŸ“‹ Recent Worker Activity:"
              for container in $(docker ps --format "{{.Names}}" | grep github-worker | head -3); do
                echo "   [$container]:"
                docker logs --tail 3 $container 2>&1 | sed 's/^/     /'
              done
              
              # Show database stats from YOUR server
              echo ""
              echo "ðŸ“Š Database Stats (Your Server):"
              PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql \
                -h ${{ env.POSTGRES_HOST }} \
                -U ${{ env.POSTGRES_USER }} \
                -d ${{ env.POSTGRES_DB }} \
                -c "SELECT 
                      (SELECT COUNT(*) FROM tasks) as tasks,
                      (SELECT COUNT(*) FROM workers) as workers,
                      (SELECT COUNT(*) FROM analytics) as analytics;" \
                2>/dev/null || echo "   Database query failed"
              
              sleep 30
            else
              echo "âŒ MCP Manager died!"
              cat /tmp/mcp-manager.log
              exit 1
            fi
          done
          
          echo ""
          echo "â±ï¸  Runtime limit reached. Shutting down gracefully..."

      - name: ðŸ“ Generate Summary
        if: always()
        run: |
          LOGS=$(tail -200 /tmp/mcp-manager.log 2>/dev/null || echo "No logs available")
          RUNTIME=$SECONDS
          NUM_WORKERS=${{ github.event.inputs.num_workers }}
          
          # Get final stats from database
          FINAL_STATS=$(PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql \
            -h ${{ env.POSTGRES_HOST }} \
            -U ${{ env.POSTGRES_USER }} \
            -d ${{ env.POSTGRES_DB }} \
            -t -c "SELECT 
                     (SELECT COUNT(*) FROM tasks) || ' tasks, ' ||
                     (SELECT COUNT(*) FROM workers) || ' workers, ' ||
                     (SELECT COUNT(*) FROM analytics) || ' analytics';" \
            2>/dev/null || echo "N/A")
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽŠ MCP System Session Complete!
          
          ### ðŸ“¦ Deployment Details
          - **Runtime**: ${RUNTIME} seconds (${{ github.event.inputs.runtime_minutes }} min configured)
          - **Mode**: ðŸ”— Hybrid (GitHub compute + Your server data)
          - **Workers Spawned**: ${NUM_WORKERS}
          - **Status**: Completed successfully âœ…
          
          ### ðŸ—ï¸ Architecture Used
          
          **GitHub Actions (Compute Layer)**:
          - âœ… MCP Manager process
          - âœ… ${NUM_WORKERS} Docker worker containers
          - âœ… All connected to your server
          
          **Your Server 165.232.134.47 (Data Layer)**:
          - âœ… NATS (4222) - Message bus
          - âœ… Redis (6379) - Cache
          - âœ… PostgreSQL (5432) - Database
          - âœ… **All data persisted!**
          
          ### ðŸ’¾ Data Saved to Your Database
          
          Final stats: ${FINAL_STATS}
          
          All tasks, worker registrations, analytics, and execution data 
          were saved to YOUR PostgreSQL database and are still there!
          
          ### âœ… Benefits of This Setup
          
          1. **Scalable compute**: Spawn workers on GitHub Actions
          2. **Persistent data**: Everything saved to your server
          3. **No data loss**: Database survives after workflow ends
          4. **Cost effective**: Use free GitHub Actions compute
          5. **Centralized data**: All data in one place (165.232.134.47)
          
          ### ðŸ“Š What Happened
          
          1. âœ… MCP Manager connected to your NATS/Redis/PostgreSQL
          2. âœ… Spawned ${NUM_WORKERS} workers on GitHub Actions
          3. âœ… Workers connected to your infrastructure
          4. âœ… All data written to your database
          5. âœ… Workers processed tasks (if assigned)
          6. âœ… Analytics captured and stored
          
          ### ðŸ“‹ Manager Logs (Last 200 Lines)
          \`\`\`
          $LOGS
          \`\`\`
          
          ### ðŸ’¡ Next Steps
          
          - Check your database: All data is preserved!
          - Run again: Spawn more workers anytime
          - Scale up: Increase num_workers for more capacity
          - Your server has ALL the historical data!
          EOF

      - name: ðŸ›‘ Cleanup
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ›‘ Cleanup (Workers and Manager)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Stop workers
          echo "Stopping workers..."
          docker ps --format "{{.Names}}" | grep github-worker | xargs -r docker stop
          docker ps -a --format "{{.Names}}" | grep github-worker | xargs -r docker rm
          
          # Stop MCP Manager
          echo "Stopping MCP Manager..."
          kill $(cat /tmp/mcp-manager.pid 2>/dev/null) 2>/dev/null || true
          
          echo ""
          echo "âœ… Cleanup complete!"
          echo ""
          echo "ðŸ’¾ Your server infrastructure (165.232.134.47) is still running"
          echo "ðŸ“Š All data is preserved in your database!"
          echo ""

